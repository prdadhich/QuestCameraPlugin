<?xml version="1.0" encoding="utf-8"?>

<root xmlns:android="http://schemas.android.com/apk/res/android">

  <!-- init section -->

  <init>

    <log text="QuestCameraPlugin init"/>

    <log text="Copying Java files from $S(PluginDir)/Source/QuestCameraPlugin/Android/src/com/stunad/questcamera"/>

    <setBool result="bSupported" value="false"/>

    <isArch arch="arm64-v8a">

      <setBool result="bSupported" value="true"/>

    </isArch>

  </init>

  <!-- Copy Java files -->

  <prebuildCopies>

    <copyFile src="$S(PluginDir)/Android/src/com/stunad/questcamera/PassthroughCameraBridge.java"

    dst="$S(BuildDir)/src/com/stunad/questcamera/PassthroughCameraBridge.java"/>

    <copyFile src="$S(PluginDir)/Android/src/com/stunad/questcamera/PassthroughCameraManager.java"

    dst="$S(BuildDir)/src/com/stunad/questcamera/PassthroughCameraManager.java"/>

  </prebuildCopies>

  <!-- AndroidManifest updates -->

  <androidManifestUpdates>

    <addPermission android:name="android.permission.CAMERA"/>

    <addPermission android:name="horizonos.permission.HEADSET_CAMERA"/>

    <addPermission android:name="horizonos.permission.AVATAR_CAMERA"/>

    <addFeature android:name="android.hardware.camera" android:required="true"/>

    <addFeature android:name="android.hardware.camera2" android:required="true"/>

    <addFeature android:name="android.hardware.camera.autofocus" android:required="false"/>

  </androidManifestUpdates>

  <!-- ProGuard rules -->

  <proguardAdditions>

    <insert>

      -keep class com.stunad.questcamera.** { *; }

      -dontwarn com.stunad.questcamera.**

    </insert>

  </proguardAdditions>

  <!-- GameActivity imports -->

  <gameActivityImportAdditions>

    <insert>

      import com.stunad.questcamera.PassthroughCameraBridge;

    </insert>

  </gameActivityImportAdditions>

  <!-- GameActivity onCreate -->

  <gameActivityOnCreateAdditions>

    <insert>

      cameraBridge = com.stunad.questcamera.PassthroughCameraBridge.getInstance(this);

    </insert>

  </gameActivityOnCreateAdditions>

  <!-- GameActivity methods -->

  <gameActivityClassAdditions>

    <insert>

      private com.stunad.questcamera.PassthroughCameraBridge cameraBridge;

      public void initCamera() {

      cameraBridge.Init(this);

      }

      public void openCamera() {

      cameraBridge.OpenCamera();

      }

      public byte[] captureImage() {

      return cameraBridge.CaptureImageNow();

      }

      public void requestPermissions() {

      cameraBridge.RequestPermissions(this);

      }

      public void closeCamera() {

      cameraBridge.CloseCamera();

      }

    </insert>

  </gameActivityClassAdditions>

  <!-- Handle permission result -->

  <gameActivityOnRequestPermissionsResultAdditions>

    <insert>

      if (requestCode == 100) {

      boolean granted = false;

      for (int i = 0; i &lt; grantResults.length; i++) {

      if (permissions[i].equals(android.Manifest.permission.CAMERA)) {

      if (grantResults[i] == android.content.pm.PackageManager.PERMISSION_GRANTED) {

      granted = true;

      android.util.Log.d("QuestCameraPlugin", "Camera permission granted");

      cameraBridge.OpenCamera();

      } else {

      android.util.Log.w("QuestCameraPlugin", "Camera permission denied");

      }

      break;

      }

      }

      }

    </insert>

  </gameActivityOnRequestPermissionsResultAdditions>




  <android>

    <architectures>

      <arm64-v8a>

        <copyFile

        src="$S(PluginDir)/Source/QuestCameraPlugin/ThirdParty/OpenCV/libs/arm64-v8a/libopencv_world.so"

        dst="$S(BuildDir)/lib/arm64-v8a/libopencv_world.so" />

      </arm64-v8a>

    </architectures>

    <soFiles>

      <soFile arch="arm64-v8a">libopencv_world.so</soFile>

    </soFiles>

  </android>

  <resourceCopies>

    <isArch arch="arm64-v8a">

      <copyFile src="$S(PluginDir)/arm64-v8a/libopencv_world.so"

      dst="$S(BuildDir)/libs/arm64-v8a/libopencv_world.so" />

    </isArch>

  </resourceCopies>



  <soLoadLibrary>

    <if condition="bSupported">

      <true>

        <loadLibrary name="opencv" failmsg="Failed to load opencv library" />

      </true>

    </if>

  </soLoadLibrary>





  <prebuildCopies>

   

    <copyFile src="$S(PluginDir)/ThirdParty/OpenCV/libs/arm64-v8a/libopencv_world.so"

    dst="lib/arm64-v8a/libopencv_world.so"/>

  </prebuildCopies>

  

  <soLoadLibrary>

    <loadLibrary name="OpenCV"/>

  </soLoadLibrary>

</root>